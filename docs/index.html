<!doctype html>
<meta charset="utf-8">

<meta http-equiv="Content-Security-Policy" content="default-src 'none'; connect-src https: https://anecdote.discoverywritten.com; style-src 'unsafe-inline'; script-src 'unsafe-inline'">
<title>QR Bootloader — Verify Manifest</title>
<style>
  :root{font-family:system-ui,Segoe UI,Roboto,Arial}
  body{display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f7f7fb}
  .card{width:min(680px,92%);background:white;padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.06);text-align:left}
  .ok{color:green}.bad{color:#b33}
  pre{background:#f2f4f7;padding:10px;border-radius:8px;overflow:auto}
  button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;font-weight:600}
</style>
<div class="card">
  <h2>Anonymous QR loader</h2>
  <p>Verifying domain manifest for <strong>anecdote.discoverywritten.com</strong>.</p>

  <div id="status">checking…</div>
  <pre id="manifest" style="display:none"></pre>
  <div style="display:flex;gap:8px">
    <button id="open" disabled>Open domain (locked)</button>
    <button id="reload">Re-check</button>
  </div>
  <p style="font-size:0.9em">Manifest signature must validate against a pinned public key. No local persistence performed yet.</p>
</div>

<script>
(async function(){
  const STATUS = document.getElementById('status');
  const MAN = document.getElementById('manifest');
  const OPEN = document.getElementById('open');
  const RELOAD = document.getElementById('reload');

  // ----- PINNED PUBLIC KEY (PEM) -----
  const PEM_PUBKEY = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuudN+p0VcuIenEQDKpFl
IDXPHoSQMVWu+T7S7XO+YEz+tUMuJDsi9ACrGS+kE+lWU++vJvVSItfF5SfGJNrR
8LHx3poVl8JQ4lqYFIUBxs9Uj+USUY48mYJgm/xFE4l3jB2HOrJLjlaffBYfcC9M
kIWIv5S33UaMfTae+QFZ52gn2TUlZ+6liIySawzMuWQ03D3urYQjoCpXItX7makE
syOENURXVlOHSHa68DMX1NuNGBe4KFWBXhc+1U8wZB2ETY7JoWY1hvVIoHz4EDtS
PL67wGFCH2NTEFWK+k/lptyX76fUmWRREqzGiSk0AkTfFahB33mtOtJ63HHhAYUd
qQIDAQAB
-----END PUBLIC KEY-----
`;

  const DOMAIN = 'https://anecdote.discoverywritten.com';
  const MANIFEST_URL = DOMAIN + '/.well-known/manifest.json';
  const SIG_URL = DOMAIN + '/.well-known/manifest.sig';

  function pemToArrayBuffer(pem){
    const b64 = pem.replace(/-----(BEGIN|END) PUBLIC KEY-----/g,'').replace(/\s+/g,'');
    const bin = atob(b64);
    const len = bin.length;
    const buf = new Uint8Array(len);
    for(let i=0;i<len;i++) buf[i]=bin.charCodeAt(i);
    return buf.buffer;
  }

  async function importPubKey(pem){
    const spki = pemToArrayBuffer(pem);
    return crypto.subtle.importKey(
      'spki', spki,
      { name: 'RSA-PSS', hash: {name:'SHA-256'} },
      false, ['verify']
    );
  }

  async function fetchTextNoCache(url){
    const r = await fetch(url, {cache:'no-store', credentials: 'omit', mode: 'cors'});
    if(!r.ok) throw new Error('fetch failed: ' + r.status);
    return await r.text();
  }

  async function verifyManifest(){
    try{
      STATUS.textContent = 'fetching manifest + signature…';
      const [manifestText, sigB64] = await Promise.all([
        fetchTextNoCache(MANIFEST_URL),
        fetchTextNoCache(SIG_URL)
      ]);
      const encoder = new TextEncoder();
      const manifestBytes = encoder.encode(manifestText);
      const sigBytes = Uint8Array.from(atob(sigB64.trim()), c => c.charCodeAt(0));

      const pub = await importPubKey(PEM_PUBKEY);
      const ok = await crypto.subtle.verify(
        {name:'RSA-PSS', saltLength: 32},
        pub,
        sigBytes,
        manifestBytes
      );

      if(!ok){
        STATUS.innerHTML = '<span class="bad">Signature invalid — do not trust this site.</span>';
        OPEN.disabled = true;
        MAN.style.display = 'none';
        return false;
      }

      STATUS.innerHTML = '<span class="ok">Signature valid — manifest verified.</span>';
      MAN.style.display = 'block';
      MAN.textContent = manifestText;
      OPEN.disabled = false;
      return true;
    }catch(err){
      STATUS.innerHTML = '<span class="bad">Error verifying manifest: '+String(err)+'</span>';
      OPEN.disabled = true;
      MAN.style.display = 'none';
      return false;
    }
  }

  OPEN.addEventListener('click', ()=>{
    const a = document.createElement('a');
    a.href = DOMAIN + '/';
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.click();
  });
  RELOAD.addEventListener('click', ()=>verifyManifest());

  await verifyManifest();
})();
</script>
